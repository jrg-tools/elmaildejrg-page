---
import Layout from '@/layouts/Layout.astro';
import { Editor } from '@/components/Editor';
import { api } from '@/lib/api';
import type { Newsletter } from '@/lib/types';

const { slug } = Astro.params;
const { getToken } = Astro.locals.auth();
let {
  id,
  content,
  blocks,
  isPublished,
  updatedAt,
  createdAt,
}: Partial<Newsletter> = {};

try {
  const token = await getToken();
  const res: Newsletter = await api.get(`/newsletter/${slug}`, { token });

  id = res.id;
  content = res.content;
  blocks = res.blocks;
  isPublished = res.isPublished;
  updatedAt = res.updatedAt;
  createdAt = res.createdAt;
} catch (error) {
  return new Response(null, { status: 404 });
}
---

<Layout
  title={slug!
    .split('-')
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ')}
  }
>
  <main class="m-auto mb-24 max-w-screen-md object-center px-4 text-center">
    <Editor
      id={id}
      content={content}
      blocks={blocks}
      isPublished={isPublished}
      updatedAt={updatedAt}
      createdAt={createdAt}
      slug={slug}
      client:only
    />
  </main>
</Layout>
